<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau de Bord - El Najeh</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/dashboard.css">
</head>
<body>
    <header>
        <a href="index.php" class="logo">El Najeh</a>
        <nav>
           
            <a href="../backend/logout.php" class="btn-logout">Déconnexion</a>
        </nav>
    </header>

    <main class="dashboard-content">
        <h1 id="welcome-message">Chargement du tableau de bord...</h1>
        <p id="user-info"></p>
        <p id="role-info"></p>

        <div class="dashboard-main-content">
            <div class="teacher-dashboard-layout">
                <!-- Bouton pour créer une annonce (visible uniquement pour les enseignants) -->
                <button id="create-annonce-btn" class="btn-primary" style="display: none; margin-bottom: 20px;">Créer une Annonce</button>

                <div class="dashboard-panels-container">
                    <div class="left-panel">
                        <!-- Section des inscriptions des élèves (visible uniquement pour les enseignants) -->
                        <section id="inscriptions-eleves-section" class="dashboard-panel" style="display: none;">
                            <h2>Matières & Groupes</h2>
                            <div id="matieres-list">
                                <p>Chargement des matières...</p>
                            </div>
                        </section>
                    </div>

                    <div class="right-content-wrapper">
                        <!-- Section pour afficher les détails des élèves pour la matière sélectionnée -->
                        <section id="eleve-details-section" class="dashboard-panel" style="display: none;">
                            <div class="section-header">
                                <h2>Élèves inscrits</h2>
                                <button id="manage-groups-btn" class="btn-secondary">Gérer les Groupes</button>
                            </div>
                            <div id="selected-matiere-eleves">
                                <p>Sélectionnez une matière pour voir les élèves inscrits.</p>
                            </div>
                            <!-- Interface de gestion des groupes (modale) -->
                            <div id="group-management-modal" class="modal">
                                <div class="modal-content">
                                    <span class="close-button">&times;</span>
                                    <h3>Gestion des Groupes pour <span id="modal-matiere-name"></span></h3>
                                    <p id="group-management-message" style="margin-bottom: 15px;"></p>
                                    
                                 

                                    <h4>Créer un nouveau groupe</h4>
                                    <div class="form-group">
                                        <label for="new-group-name">Nom du groupe:</label>
                                        <input type="text" id="new-group-name" placeholder="Ex: Groupe A, Groupe de Travail 1" required>
                                    </div>
                                    <div id="unassigned-students-list-for-creation" class="student-selection-list" style="margin-top: 15px;">
                                        <!-- Les élèves non affectés seront chargés ici pour la sélection lors de la création de groupe -->
                                        <p>Chargement des élèves non affectés...</p>
                                    </div>
                                    <button id="create-group-btn" class="btn-primary" style="margin-top: 10px;">Créer le Groupe</button>
                                </div>
                            </div>
                        </section>
                    </div>
                </div>
            </div>

            <!-- Section de création d'annonce (déplacée en dehors du flux principal pour un affichage conditionnel) -->
            <section id="create-annonce-section" class="dashboard-panel" style="display: none;">
                <h2>Créer une Nouvelle Annonce</h2>
                <form id="annonce-form">
                    <div class="form-group">
                        <label for="matiere-select">Matière:</label>
                        <select id="matiere-select" name="matiere_id" required>
                            <!-- Les options de matière seront chargées ici par JavaScript -->
                            <option value="">Sélectionnez une matière</option>
                            <option value="other">Autre (taper une nouvelle matière)</option>
                        </select>
                        <input type="text" id="new-matiere-input" name="new_matiere_name" placeholder="Entrez le nom de la nouvelle matière" style="display: none; margin-top: 10px;">
                    </div>
                    <div class="form-group">
                        <label for="titre">Titre de l'annonce:</label>
                        <input type="text" id="titre" name="titre" required>
                    </div>
                    <div class="form-group">
                        <label for="description">Description:</label>
                        <textarea id="description" name="description" rows="5" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="niveau">Niveau:</label>
                        <input type="text" id="niveau" name="niveau" placeholder="Ex: BAC, Licence 1, 3ème" required>
                    </div>
                    <div class="form-group">
                        <label for="prix-unitaire">Prix Unitaire (€/heure):</label>
                        <input type="number" id="prix-unitaire" name="prix_unitaire" step="0.01" min="0" required>
                    </div>
                    <button type="submit" class="btn-primary">Publier l'Annonce</button>
                    <button type="button" id="cancel-annonce-btn" class="btn-secondary">Annuler</button>
                </form>
                <p id="annonce-message" style="margin-top: 15px;"></p>
            </section>
        </div>
    </main>

    <footer>
        <p>&copy; 2025 El Najeh. Tous droits réservés.</p>
    </footer>
    <script src="js/auth.js"></script>
    <script src="js/script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const createAnnonceBtn = document.getElementById('create-annonce-btn');
            const createAnnonceSection = document.getElementById('create-annonce-section');
            const cancelAnnonceBtn = document.getElementById('cancel-annonce-btn');
            const annonceForm = document.getElementById('annonce-form');
            const matiereSelect = document.getElementById('matiere-select');
            const newMatiereInput = document.getElementById('new-matiere-input');
            const annonceMessage = document.getElementById('annonce-message');
            const inscriptionsElevesSection = document.getElementById('inscriptions-eleves-section');
            const matieresList = document.getElementById('matieres-list'); // Renommé de inscriptionsList
            const eleveDetailsSection = document.getElementById('eleve-details-section');
            const selectedMatiereEleves = document.getElementById('selected-matiere-eleves');

            // Fonction pour charger les matières
            async function loadMatieres() {
                try {
                    const response = await fetch('../backend/get_matieres.php');
                    const data = await response.json();

                    if (data.success) {
                        // Clear existing options except "Sélectionnez une matière" and "Autre"
                        matiereSelect.querySelectorAll('option:not([value=""]):not([value="other"])').forEach(option => option.remove());

                        data.matieres.forEach(matiere => {
                            const option = document.createElement('option');
                            option.value = matiere.id;
                            option.textContent = matiere.nom;
                            matiereSelect.insertBefore(option, matiereSelect.lastElementChild); // Insert before "Autre"
                        });
                    } else {
                        console.error('Erreur lors du chargement des matières:', data.message);
                        annonceMessage.textContent = 'Erreur lors du chargement des matières: ' + data.message;
                        annonceMessage.style.color = 'red';
                    }
                } catch (error) {
                    console.error('Erreur réseau lors du chargement des matières:', error);
                    annonceMessage.textContent = 'Erreur réseau lors du chargement des matières.';
                    annonceMessage.style.color = 'red';
                }
            }

            // Charger les matières au chargement de la page
            loadMatieres();

            // Gérer l'affichage du champ "Nouvelle matière"
            matiereSelect.addEventListener('change', function() {
                if (this.value === 'other') {
                    newMatiereInput.style.display = 'block';
                    newMatiereInput.setAttribute('required', 'required');
                } else {
                    newMatiereInput.style.display = 'none';
                    newMatiereInput.removeAttribute('required');
                }
            });

            // Afficher/Masquer la section de création d'annonce
            createAnnonceBtn.addEventListener('click', function() {
                createAnnonceSection.style.display = 'block';
                createAnnonceBtn.style.display = 'none';
                annonceMessage.textContent = ''; // Clear previous messages
                annonceForm.reset(); // Reset form fields
                newMatiereInput.style.display = 'none'; // Hide new matiere input
                newMatiereInput.removeAttribute('required');
                matiereSelect.value = ''; // Reset select to default
                inscriptionsElevesSection.style.display = 'none'; // Masquer la section des inscriptions
                eleveDetailsSection.style.display = 'none'; // Masquer la section des détails des élèves
            });

            cancelAnnonceBtn.addEventListener('click', function() {
                createAnnonceSection.style.display = 'none';
                createAnnonceBtn.style.display = 'block';
                // Ne pas recharger les inscriptions ici, cela sera géré par le checkUserRole
            });

            // Gérer la soumission du formulaire d'annonce
            annonceForm.addEventListener('submit', async function(event) {
                event.preventDefault();

                annonceMessage.textContent = 'Publication de l\'annonce...';
                annonceMessage.style.color = 'blue';

                const formData = new FormData(annonceForm);
                const data = {};
                formData.forEach((value, key) => {
                    data[key] = value;
                });

                // Si "Autre" est sélectionné, utiliser le champ new_matiere_name et supprimer matiere_id
                if (data['matiere_id'] === 'other') {
                    if (!data['new_matiere_name'] || data['new_matiere_name'].trim() === '') {
                        annonceMessage.textContent = 'Veuillez entrer le nom de la nouvelle matière.';
                        annonceMessage.style.color = 'red';
                        return;
                    }
                    delete data['matiere_id']; // Remove matiere_id if a new one is being added
                } else if (!data['matiere_id']) {
                    annonceMessage.textContent = 'Veuillez sélectionner une matière.';
                    annonceMessage.style.color = 'red';
                    return;
                } else {
                    delete data['new_matiere_name']; // Remove new_matiere_name if an existing one is selected
                }

                try {
                    const response = await fetch('../backend/create_annonce.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });
                    const result = await response.json();

                    if (result.success) {
                        annonceMessage.textContent = 'Annonce créée avec succès !';
                        annonceMessage.style.color = 'green';
                        annonceForm.reset(); // Réinitialiser le formulaire
                        newMatiereInput.style.display = 'none';
                        newMatiereInput.removeAttribute('required');
                        matiereSelect.value = '';
                        loadMatieres(); // Recharger les matières pour inclure la nouvelle si ajoutée
                        // Optionnel: masquer le formulaire après succès
                        // createAnnonceSection.style.display = 'none';
                        // createAnnonceBtn.style.display = 'block';
                        loadInscriptions(); // Recharger les inscriptions après la création d'une annonce
                    } else {
                        annonceMessage.textContent = 'Erreur: ' + result.message;
                        annonceMessage.style.color = 'red';
                    }
                } catch (error) {
                    console.error('Erreur réseau lors de la création de l\'annonce:', error);
                    annonceMessage.textContent = 'Erreur réseau lors de la création de l\'annonce.';
                    annonceMessage.style.color = 'red';
                }
            });

            // Fonction pour charger les inscriptions des élèves (rendue globale pour être appelée par auth.js)
            window.loadInscriptions = async function() {
                try {
                    const response = await fetch('../backend/get_inscriptions_enseignant.php');
                    const result = await response.json();

                    if (result.success) {
                        matieresList.innerHTML = ''; // Clear previous content
                        selectedMatiereEleves.innerHTML = '<p>Sélectionnez une matière pour voir les élèves inscrits.</p>'; // Reset right panel

                        if (result.matieres && result.matieres.length > 0) {
                            result.matieres.forEach(matiereData => {
                                const matiereItem = document.createElement('div');
                                matiereItem.classList.add('matiere-item');
                                matiereItem.dataset.matiereId = matiereData.matiere_id;
                                matiereItem.dataset.matiereName = matiereData.matiere_nom;
                                matiereItem.innerHTML = `
                                    <div class="matiere-name">${matiereData.matiere_nom}</div>
                                    <ul class="group-names-list">
                                        ${matiereData.groups.map(group => `<li>${group.nom}</li>`).join('')}
                                        ${matiereData.unassigned_students.length > 0 ? '<li>Non affectés</li>' : ''}
                                    </ul>
                                `;
                                matieresList.appendChild(matiereItem);

                                // Add click event to show students for this matiere
                                matiereItem.addEventListener('click', () => {
                                    document.querySelectorAll('.matiere-item').forEach(item => item.classList.remove('active'));
                                    matiereItem.classList.add('active');

                                    // Update currentMatiereId and currentMatiereName for group management
                                    currentMatiereId = matiereData.matiere_id;
                                    currentMatiereName = matiereData.matiere_nom;

                                    selectedMatiereEleves.innerHTML = `<h3>Élèves inscrits à ${matiereData.matiere_nom}</h3>`;
                                    
                                    // Display groups and their students
                                    if (matiereData.groups.length > 0) {
                                        matiereData.groups.forEach(group => {
                                            const groupDiv = document.createElement('div');
                                            groupDiv.classList.add('group-card');
                                            groupDiv.innerHTML = `
                                                <h4>${group.nom}</h4>
                                                <ul class="student-list">
                                                    ${group.students.map(student => `
                                                        <li>
                                                            ${student.eleve_prenom} ${student.eleve_nom}
                                                        </li>
                                                    `).join('')}
                                                </ul>
                                            `;
                                            selectedMatiereEleves.appendChild(groupDiv);
                                        });
                                    }

                                    // Display unassigned students
                                    if (matiereData.unassigned_students.length > 0) {
                                        const unassignedDiv = document.createElement('div');
                                        unassignedDiv.classList.add('group-card');
                                        unassignedDiv.innerHTML = `
                                            <h4>Non affectés</h4>
                                            <ul class="student-list">
                                                ${matiereData.unassigned_students.map(student => `
                                                    <li>
                                                        ${student.eleve_prenom} ${student.eleve_nom}
                                                    </li>
                                                `).join('')}
                                            </ul>
                                        `;
                                        selectedMatiereEleves.appendChild(unassignedDiv);
                                    } else if (matiereData.groups.length === 0) {
                                        selectedMatiereEleves.innerHTML += '<p>Aucun élève inscrit ou tous les élèves sont affectés à un groupe.</p>';
                                    }
                                    eleveDetailsSection.style.display = 'block'; // Show right panel
                                });
                            });
                        } else {
                            matieresList.innerHTML = '<p>Aucune matière avec des élèves inscrits pour le moment.</p>';
                        }
                        inscriptionsElevesSection.style.display = 'block';
                    } else {
                        let errorMessage = '<p>Erreur lors du chargement des inscriptions: ' + result.message + '</p>';
                        if (result.error_details) {
                            errorMessage += '<p>Détails: ' + result.error_details + '</p>';
                        }
                        if (result.trace) {
                            errorMessage += '<pre>Trace: ' + result.trace + '</pre>';
                        }
                        matieresList.innerHTML = errorMessage;
                        inscriptionsElevesSection.style.display = 'block';
                    }
                } catch (error) {
                    console.error('Erreur réseau lors du chargement des inscriptions:', error);
                    matieresList.innerHTML = '<p>Erreur réseau lors du chargement des inscriptions.</p>';
                    inscriptionsElevesSection.style.display = 'block';
                }
            }

            // La fonction checkUserRole est définie dans auth.js
            // Elle est appelée au chargement de la page et gère l'affichage des sections
            // Nous allons modifier auth.js pour qu'il appelle loadInscriptions si l'utilisateur est un enseignant.
            // Pour l'instant, nous allons commenter l'appel direct ici.
            // loadInscriptions();
        });
    </script>
</body>
</html>
